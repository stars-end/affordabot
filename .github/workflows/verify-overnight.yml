# Overnight Verification CI Workflow
# Runs comprehensive RAG pipeline verification at 2 AM Pacific (10:00 UTC) daily
# Uses GLM-4.6V for visual validation via UISmokeAgent

name: Overnight Verification

on:
  schedule:
    # 2 AM Pacific = 10:00 UTC (PST) or 09:00 UTC (PDT)
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Frontend URL to verify (default: production)'
        required: false
        default: ''

env:
  PYTHON_VERSION: '3.13'

jobs:
  verify-affordabot:
    runs-on: self-hosted
    permissions:
      contents: read
      issues: write
    timeout-minutes: 45
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup mise (pre-installed)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          eval "$(mise activate bash)"
          mise install --yes
          echo "PATH=$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH" >> $GITHUB_ENV
          
      - name: Clean old artifacts
        run: |
          # Remove any old artifacts with colons in filename
          find artifacts/verification -name "*:*" -delete 2>/dev/null || true
          
      - name: Install Dependencies  
        run: |
          export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"
          eval "$(mise activate bash)"
          cd backend
          # Use mise-provided Python for Poetry
          poetry env use $(which python)
          poetry install
          
      - name: Install Playwright
        run: |
          export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"
          eval "$(mise activate bash)"
          cd backend
          poetry run playwright install chromium

          
      - name: Run Unified Verification (Nightly)
        env:
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          TEST_AUTH_BYPASS_SECRET: ${{ secrets.TEST_AUTH_BYPASS_SECRET }}
          FRONTEND_URL: ${{ github.event.inputs.base_url || 'https://frontend-dev-5093.up.railway.app' }}
        run: |
          export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"
          eval "$(mise activate bash)"
          # Standardization: use the canonical Makefile target
          make verify-nightly
          

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-report-${{ github.run_id }}
          path: artifacts/verification/
          retention-days: 30
          
      - name: Triage & Report to Beads
        if: always()
        env:
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
        run: |
          export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"
          eval "$(mise activate bash)"
          # Find the latest nightly run dir
          RUN_DIR=$(ls -td artifacts/verification/nightly/*/ | head -n 1)
          if [ -z "$RUN_DIR" ]; then
            echo "‚ö†Ô∏è No run directory found for triage."
            exit 0
          fi
          echo "üîç Triaging run: $RUN_DIR"
          cd backend
          poetry run python -m llm_common.agents.uismoke_runner triage --run-dir "../$RUN_DIR"

      # Emit VERIFY_COMPLETE event to Agent Event Bus
      - name: Emit Verification Event
        if: always()
        env:
          SLACK_MCP_XOXB_TOKEN: ${{ secrets.SLACK_MCP_XOXB_TOKEN }}
          SLACK_MCP_ADD_MESSAGE_TOOL: "true"
        run: |
          # Determine pass/fail
          if [ "${{ job.status }}" = "success" ]; then
            PASSED="true"
          else
            PASSED="false"
          fi
          
          # Run emit script (best-effort)
          ./scripts/emit-review-event.sh "affordabot" "0" "$PASSED" "" "Overnight verification ${{ job.status }}" || echo "Warning: Failed to emit event"

