name: Nightly Fleet Dispatcher

on:
  schedule:
    # 10 PM PT to 5 AM PT (PST is UTC-8)
    # 10 PM PST = 06:00 UTC
    # 5 AM PST = 13:00 UTC
    - cron: '0 6-13 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry Run (Simulate Only)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dispatch:
    runs-on: self-hosted
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout Agent Skills
        uses: actions/checkout@v4
        with:
          repository: stars-end/agent-skills
          path: agent-skills
      
      - name: Setup mise
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          eval "$(mise activate bash)"
          echo "PATH=$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH" >> $GITHUB_ENV

      - name: Setup Tools
        run: |
          export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"
          eval "$(mise activate bash)"
          
          # Install Beads CLI via official install script
          if ! command -v bd &> /dev/null; then
            echo "Installing Beads CLI..."
            curl -fsSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash
            export PATH="$HOME/.local/bin:$PATH"
          fi
          
          # Verify bd is installed
          if ! command -v bd &> /dev/null; then
            echo "ERROR: Failed to install Beads CLI"
            exit 1
          fi
          bd --version
          
          # Ensure dx-dispatch is available
          if [ -f "$HOME/agent-skills/scripts/dx-dispatch.py" ]; then
            echo "dx-dispatch found at $HOME/agent-skills"
            ln -sf "$HOME/agent-skills/scripts/dx-dispatch.py" "$HOME/.local/bin/dx-dispatch" 2>/dev/null || true
          fi
      
      - name: Initialize Beads
        run: |
          export BEADS_DIR="${BEADS_DIR:-$HOME/bd/.beads}"
          echo "Using external BEADS_DIR: $BEADS_DIR"
          echo "BEADS_DIR=$BEADS_DIR" >> $GITHUB_ENV
          mkdir -p "$BEADS_DIR"
          if [ -d "$BEADS_DIR" ]; then
            echo "Beads DB exists at $BEADS_DIR"
            if [ -f "$BEADS_DIR/config.yaml" ]; then
              bd config list
            fi
          else
            echo "WARNING: BEADS_DIR not found: $BEADS_DIR"
          fi
          
      - name: Install dependencies
        run: |
          python3 -m venv .venv
          .venv/bin/pip install httpx slack_sdk

      - name: Run Fleet Dispatcher
        env:
          PATH: /usr/local/bin:/usr/bin:/bin:$HOME/.local/bin:$HOME/.local/share/mise/shims
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"
          eval "$(mise activate bash)"
          
          ARGS=""
          if [[ "${{ inputs.dry_run }}" == "true" ]]; then
            ARGS="--dry-run"
          fi
          
          # Run the dispatcher for affordabot
          export DX_DISPATCH_PATH="$GITHUB_WORKSPACE/agent-skills/scripts/dx-dispatch.py"
          export REPO="affordabot"
          .venv/bin/python scripts/jules/nightly_dispatch.py $ARGS
